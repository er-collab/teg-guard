<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>TEG 3.2.2 - à¸šà¸±à¸•à¸£à¸à¸™à¸±à¸à¸‡à¸²à¸™à¸ à¸²à¸¢à¸™à¸­à¸</title>

<!-- à¸ªà¸£à¹‰à¸²à¸‡ QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<!-- à¸­à¹ˆà¸²à¸™ QR à¸ˆà¸²à¸à¸à¸¥à¹‰à¸­à¸‡/à¸£à¸¹à¸› -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');

* { box-sizing: border-box; touch-action: manipulation; }
body {
  font-family: 'Sarabun', -apple-system, BlinkMacSystemFont, sans-serif;
  margin: 0;
  background-image: url('https://img2.pic.in.th/pic/29a2bfcf779db2329.jpg');
  background-size: cover;
  background-position: center;
  background-attachment: fixed;
  min-height: 100vh;
  padding: 15px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  color: #2c3e50;
  -webkit-tap-highlight-color: transparent;
}

/* à¸›à¸¸à¹ˆà¸¡à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ à¸²à¸©à¸² */
.lang-switcher {
  position: absolute;
  top: 20px;
  right: 20px;
  display: flex;
  gap: 8px;
  z-index: 1000;
}
.lang-btn {
  width: 44px;
  height: 44px;
  border: 2px solid rgba(255,255,255,0.3);
  border-radius: 12px;
  background: rgba(255,255,255,0.9);
  color: #374151;
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s ease;
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  touch-action: manipulation;
}
.lang-btn.active {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  border-color: #3b82f6;
  box-shadow: 0 4px 15px rgba(59,130,246,0.3);
}
.lang-btn:active { transform: scale(0.95); }

.container {
  background: rgba(255, 255, 255, 0.92);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 24px;
  padding: 28px 24px;
  width: 100%;
  max-width: 420px;
  max-height: 95vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
  position: relative;
  margin-top: 80px;
}

h1 {
  text-align: center;
  color: #1a1a1a;
  font-weight: 600;
  font-size: clamp(1.4rem, 4vw, 1.6rem);
  margin: 0 0 20px 0;
  letter-spacing: 0.5px;
}

.form-section, .card-section { display: flex; flex-direction: column; gap: 20px; }

.form-group { display: flex; flex-direction: column; gap: 8px; }
label { font-weight: 500; color: #374151; font-size: 0.95rem; letter-spacing: 0.3px; }
select, input[type="text"], input[type="file"] {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.8);
  font-family: inherit;
  font-size: 1rem;
  color: #1f2937;
  font-weight: 400;
  transition: all 0.2s ease;
  backdrop-filter: blur(10px);
}
select option { font-family: inherit; }
input:focus, select:focus {
  outline: none;
  border-color: #3b82f6;
  background: rgba(255, 255, 255, 0.95);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
input[type="file"] {
  padding: 12px;
}
input[type="file"]::file-selector-button {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 8px;
  font-weight: 500;
  cursor: pointer;
  margin-right: 12px;
  transition: all 0.2s;
}
input[type="file"]::file-selector-button:active {
  background: linear-gradient(135deg, #1d4ed8, #1e40af);
  transform: translateY(-1px);
}

.pdpa-notice {
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border: 1px solid #f59e0b;
  border-radius: 12px;
  padding: 16px;
  margin: 20px 0;
  font-size: 0.85rem;
  line-height: 1.5;
  color: #92400e;
}
.pdpa-notice h4 { color: #b45309; margin: 0 0 8px 0; font-weight: 600; font-size: 0.95rem; }
.pdpa-checkbox {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  margin-top: 12px;
}
.pdpa-checkbox input[type="checkbox"] {
  width: auto;
  margin: 2px 0 0 0;
  transform: scale(1.2);
}

.main-button {
  width: 100%;
  padding: 16px;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  font-size: 1.05rem;
  cursor: pointer;
  transition: all 0.2s ease;
  letter-spacing: 0.5px;
  touch-action: manipulation;
}
.generate-button {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  color: white;
  box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
}
.generate-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 12px 35px rgba(59, 130, 246, 0.5);
}
.generate-button:active:not(:disabled) {
  transform: translateY(0);
}
.generate-button:disabled {
  background: #9ca3af;
  cursor: not-allowed;
  transform: none;
}

#preview1 {
  width: 100px;
  height: 130px;
  object-fit: cover;
  border-radius: 10px;
  border: 2px solid #e5e7eb;
  margin-top: 8px;
  display: none;
}

.employee-card {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 20px;
  padding: 0;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.4);
  overflow: hidden;
  backdrop-filter: blur(10px);
}

.card-header {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  padding: 24px 28px 20px;
  text-align: center;
  border-bottom: 1px solid rgba(226, 232, 240, 0.8);
}
.card-company {
  font-weight: 600;
  font-size: 1.1rem;
  color: #1e293b;
  margin: 0 0 4px 0;
}
.card-subtitle {
  font-size: 0.85rem;
  color: #64748b;
  font-weight: 400;
  margin: 0;
}

.card-body {
  padding: 28px;
  display: flex;
  gap: 20px;
}
.card-photo {
  width: 100px;
  height: 130px;
  border-radius: 14px;
  object-fit: cover;
  flex-shrink: 0;
  border: 3px solid rgba(255, 255, 255, 0.8);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}
.card-details {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.detail-row { display: flex; align-items: flex-start; gap: 12px; }
.detail-label {
  font-weight: 600;
  font-size: 0.9rem;
  color: #374151;
  min-width: 55px;
  flex-shrink: 0;
}
.detail-value {
  font-weight: 500;
  font-size: 1rem;
  color: #1f2937;
  flex: 1;
}

.qr-container {
  margin-top: 24px;
  padding: 24px;
  background: rgba(255, 255, 255, 0.98);
  border-radius: 20px;
  border: 1px solid rgba(226, 232, 240, 0.8);
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
  text-align: center;
}
.qr-title {
  font-weight: 600;
  font-size: 1.05rem;
  color: #1f2937;
  margin-bottom: 16px;
  letter-spacing: 0.3px;
}
#qr-canvas {
  width: 240px;
  height: 240px;
  border: 3px solid #f3f4f6;
  border-radius: 16px;
  background: white;
  box-shadow: 0 10px 35px rgba(0, 0, 0, 0.15);
  margin: 0 auto 16px;
}
.qr-hint { font-size: 0.9rem; color: #6b7280; line-height: 1.5; }

.status-info {
  background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
  border: 1px solid #a7f3d0;
  border-radius: 12px;
  padding: 16px;
  margin-top: 20px;
  text-align: center;
}
.status-info h3 { color: #166534; font-size: 1.1rem; font-weight: 600; margin: 0 0 8px 0; }
.status-info p { color: #047857; margin: 0; font-size: 0.95rem; }

@media (max-width: 480px) {
  .container { padding: 20px 16px; margin-top: 100px; }
  .card-body { flex-direction: column; gap: 16px; }
  .card-photo { width: 100%; height: 120px; align-self: center; }
  #qr-canvas { width: 220px; height: 220px; }
}

/* ===== à¸›à¸¸à¹ˆà¸¡à¹€à¸Ÿà¸·à¸­à¸‡ à¸£à¸›à¸ . à¸¡à¸¸à¸¡à¸¥à¹ˆà¸²à¸‡à¸‚à¸§à¸² ===== */
.guard-settings {
  position: fixed;
  bottom: 25px;
  right: 25px;
  z-index: 1000;
}
.guard-btn {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  border: 3px solid rgba(255,255,255,0.4);
  background: rgba(255,255,255,0.98);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  backdrop-filter: blur(15px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  transition: all 0.3s ease;
  animation: pulse 2s infinite;
  touch-action: manipulation;
}
.guard-btn:active {
  transform: scale(0.95) rotate(10deg);
  background: white;
  box-shadow: 0 12px 35px rgba(59,130,246,0.4);
}
.guard-btn svg {
  width: 26px;
  height: 26px;
  fill: #ef4444;
  stroke: #dc2626;
  stroke-width: 1.5;
}
@keyframes pulse {
  0%, 100% { box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
  50% { box-shadow: 0 8px 35px rgba(239,68,68,0.4); }
}

/* Modal login à¸£à¸›à¸ . */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.8);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  backdrop-filter: blur(5px);
}
.modal {
  background: white;
  border-radius: 20px;
  padding: 24px;
  width: 90%;
  max-width: 380px;
  box-shadow: 0 25px 70px rgba(0,0,0,0.4);
}
.modal h2 { margin: 0 0 12px 0; font-size: 1.2rem; color: #111; text-align: center; }
.modal p { margin: 0 0 12px 0; font-size: 0.9rem; color: #4b5563; text-align: center; }
.modal input {
  width: 100%;
  padding: 14px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  font-size: 1rem;
  margin-bottom: 16px;
}
.modal input:focus { border-color: #3b82f6; outline: none; }
.modal-buttons { display: flex; gap: 12px; justify-content: flex-end; }
.btn-small {
  flex: 1;
  padding: 12px;
  border-radius: 12px;
  border: none;
  font-weight: 500;
  cursor: pointer;
  touch-action: manipulation;
}
.btn-cancel { background: #f3f4f6; color: #374151; }
.btn-login { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }

/* à¹à¸œà¸‡ à¸£à¸›à¸ . */
.guard-panel {
  display: none;
  background: rgba(255,255,255,0.95);
  border-radius: 20px;
  padding: 20px;
  margin-top: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.2);
  max-height: 80vh;
  overflow-y: auto;
}
.guard-tabs { display: flex; gap: 8px; margin-bottom: 20px; }
.tab-btn {
  flex: 1;
  padding: 12px;
  border: 2px solid #e5e7eb;
  background: white;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 500;
  touch-action: manipulation;
}
.tab-btn.active {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  border-color: #3b82f6;
}

.scan-section, .report-section { display: none; }
.scan-section.active, .report-section.active { display: block; }

#video {
  width: 100%;
  height: 260px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  background: #f9fafb;
}
#canvas { display: none; }

.scan-controls {
  margin-top: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.scan-controls label {
  font-size: 0.85rem;
  color: #4b5563;
}

.employee-detail {
  background: linear-gradient(135deg, #ecfdf5, #d1fae5);
  border-radius: 16px;
  padding: 20px;
  border: 1px solid #a7f3d0;
  margin-top: 16px;
}
.employee-photo {
  width: 100px;
  height: 130px;
  object-fit: cover;
  border-radius: 12px;
  margin: 0 auto 16px;
  display: block;
  border: 3px solid white;
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}
.detail-grid {
  display: grid;
  grid-template-columns: 1fr 2fr;
  gap: 12px;
  font-size: 0.95rem;
}
.detail-label { font-weight: 600; color: #047857; }

.guard-confirm-btn {
  margin-top: 14px;
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  border: none;
  background: linear-gradient(135deg, #f97316, #ea580c);
  color: white;
  font-weight: 600;
  cursor: pointer;
  touch-action: manipulation;
}

/* à¸£à¸²à¸¢à¸‡à¸²à¸™ */
.report-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}
.report-table th {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  padding: 12px 8px;
  font-weight: 600;
}
.report-table td { padding: 10px 8px; border-bottom: 1px solid #e5e7eb; }
.report-table tr:hover { background: #f8fafc; }
.photo-cell { width: 60px; text-align: center; }
.photo-cell img {
  width: 40px;
  height: 50px;
  object-fit: cover;
  border-radius: 6px;
}

.export-btn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  margin-top: 16px;
  touch-action: manipulation;
}
</style>
</head>
<body>

<!-- à¸›à¸¸à¹ˆà¸¡à¹€à¸Ÿà¸·à¸­à¸‡ à¸£à¸›à¸ . à¸¡à¸¸à¸¡à¸¥à¹ˆà¸²à¸‡à¸‚à¸§à¸² -->
<div class="guard-settings">
  <button class="guard-btn" id="guardBtn" title="à¹‚à¸«à¸¡à¸” à¸£à¸›à¸ .">
    <svg viewBox="0 0 24 24">
      <path d="M12 8.5A3.5 3.5 0 1 0 12 15.5 3.5 3.5 0 0 0 12 8.5zm8.94 2.57-1.35-.78a7.1 7.1 0 0 0-.32-1.07l.67-1.43a.75.75 0 0 0-.16-.86l-1.5-1.5a.75.75 0 0 0-.86-.16l-1.43.67c-.35-.13-.71-.24-1.07-.32L14.75 4h-1.5l-.17 1.52c-.36.08-.72.19-1.07.32l-1.43-.67a.75.75 0 0 0-.86.16l-1.5 1.5a.75.75 0 0 0-.16.86l.67 1.43c-.13.35-.24.71-.32 1.07l-1.52.17v1.5l1.52.17c.08.36.19.72.32 1.07l-.67 1.43a.75.75 0 0 0 .16.86l1.5 1.5c.21.21.53.27.8.16l1.43-.67c.35.13.71.24 1.07.32l.17 1.52h1.5l.17-1.52c.36-.08.72-.19 1.07-.32l1.43.67c.27.11.59.05.8-.16l1.5-1.5a.75.75 0 0 0 .16-.86l-.67-1.43c.13-.35.24-.71.32-1.07l1.35-.78v-1.5z"/>
    </svg>
  </button>
</div>

<!-- à¸›à¸¸à¹ˆà¸¡à¸ à¸²à¸©à¸² -->
<div class="lang-switcher">
  <button class="lang-btn active" data-lang="th">à¹„à¸—à¸¢</button>
  <button class="lang-btn" data-lang="mm">á€™á€¼á€”á€ºá€™á€¬</button>
  <button class="lang-btn" data-lang="km">ááŸ’á˜áŸ‚áš</button>
</div>

<!-- Modal login à¸£à¸›à¸ . -->
<div class="modal-backdrop" id="guardModal">
  <div class="modal">
    <h2>ğŸ” à¹€à¸‚à¹‰à¸²à¹‚à¸«à¸¡à¸” à¸£à¸›à¸ .</h2>
    <p>à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™</p>
    <input type="password" id="guardPassword" placeholder="********">
    <div class="modal-buttons">
      <button class="btn-small btn-cancel" id="cancelLogin">à¸¢à¸à¹€à¸¥à¸´à¸</button>
      <button class="btn-small btn-login" id="confirmLogin">à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š</button>
    </div>
  </div>
</div>

<!-- à¹à¸œà¸‡ à¸£à¸›à¸ . -->
<div class="guard-panel" id="guardPanel">
  <div class="guard-tabs">
    <button class="tab-btn active" data-tab="scan">à¸ªà¹à¸à¸™ QR</button>
    <button class="tab-btn" data-tab="report">à¸£à¸²à¸¢à¸‡à¸²à¸™</button>
  </div>

  <div class="scan-section active" id="scanTab">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="canvas"></canvas>
    <div class="scan-controls">
      <label>
        à¸«à¸£à¸·à¸­à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸£à¸¹à¸› QR à¸ˆà¸²à¸à¸­à¸±à¸¥à¸šà¸±à¹‰à¸¡:
        <input type="file" id="qrImageInput" accept="image/*">
      </label>
    </div>
    <div id="scan-result" class="employee-detail" style="display:none;">
      <img id="scan-photo" class="employee-photo" alt="à¸£à¸¹à¸›à¸à¸™à¸±à¸à¸‡à¸²à¸™">
      <div class="detail-grid">
        <div class="detail-label">à¸Šà¸·à¹ˆà¸­:</div><div id="scan-name"></div>
        <div class="detail-label">à¸£à¸«à¸±à¸ª:</div><div id="scan-code"></div>
        <div class="detail-label">à¸šà¸£à¸´à¸©à¸±à¸—:</div><div id="scan-company"></div>
        <div class="detail-label">à¹à¸œà¸™à¸:</div><div id="scan-dept"></div>
        <div class="detail-label">à¹€à¸§à¸¥à¸²à¹à¸ˆà¹‰à¸‡à¸­à¸­à¸:</div><div id="scan-time"></div>
        <div class="detail-label">à¸£à¸›à¸ .à¸¢à¸·à¸™à¸¢à¸±à¸™:</div><div id="scan-guard-time"></div>
      </div>
      <button class="guard-confirm-btn" id="guardConfirmBtn">âœ… à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š</button>
    </div>
  </div>

  <div class="report-section" id="reportTab">
    <table class="report-table" id="reportTable">
      <thead>
        <tr>
          <th>à¸£à¸¹à¸›</th>
          <th>à¸Šà¸·à¹ˆà¸­</th>
          <th>à¸£à¸«à¸±à¸ª</th>
          <th>à¸šà¸£à¸´à¸©à¸±à¸—</th>
          <th>à¹à¸œà¸™à¸</th>
          <th>à¹€à¸§à¸¥à¸²à¹à¸ˆà¹‰à¸‡à¸­à¸­à¸</th>
          <th>à¹€à¸§à¸¥à¸²à¸£à¸›à¸ .à¸¢à¸·à¸™à¸¢à¸±à¸™</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="export-btn" id="exportExcel">ğŸ“Š à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸” Excel</button>
  </div>
</div>

<!-- Main à¸à¸™à¸±à¸à¸‡à¸²à¸™ -->
<div class="container" id="main-container"></div>

<script>
const translations = {
  th: {
    title: "à¸‚à¸­à¸­à¸™à¸¸à¸à¸²à¸•à¸­à¸­à¸à¸™à¸­à¸à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆ",
    subtitle: "à¸à¸£à¸“à¸µ 3.2.2 - à¸à¸™à¸±à¸à¸‡à¸²à¸™à¸à¸±à¸à¸­à¸²à¸¨à¸±à¸¢à¸ à¸²à¸¢à¸™à¸­à¸",
    name: "à¸Šà¸·à¹ˆà¸­-à¸™à¸²à¸¡à¸ªà¸à¸¸à¸¥",
    code: "à¸£à¸«à¸±à¸ªà¸à¸™à¸±à¸à¸‡à¸²à¸™",
    company: "à¸šà¸£à¸´à¸©à¸±à¸—",
    dept: "à¹à¸œà¸™à¸",
    photo: "à¸£à¸¹à¸›à¸–à¹ˆà¸²à¸¢à¸à¸™à¸±à¸à¸‡à¸²à¸™",
    generate: "à¸ªà¸£à¹‰à¸²à¸‡à¸šà¸±à¸•à¸£à¸à¸™à¸±à¸à¸‡à¸²à¸™",
    pdpa_title: "PDPA - à¸™à¹‚à¸¢à¸šà¸²à¸¢à¸„à¸§à¸²à¸¡à¹€à¸›à¹‡à¸™à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§",
    pdpa_text: `à¸šà¸£à¸´à¸©à¸±à¸—à¹ƒà¸™à¸à¸²à¸™à¸°à¸œà¸¹à¹‰à¸„à¸§à¸šà¸„à¸¸à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸§à¸™à¸šà¸¸à¸„à¸„à¸¥ à¸ˆà¸°à¹€à¸à¹‡à¸šà¸£à¸§à¸šà¸£à¸§à¸¡ à¹ƒà¸Šà¹‰ à¹à¸¥à¸°à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸§à¸™à¸šà¸¸à¸„à¸„à¸¥à¸‚à¸­à¸‡à¸—à¹ˆà¸²à¸™ à¹„à¸”à¹‰à¹à¸à¹ˆ à¸Šà¸·à¹ˆà¸­â€“à¸ªà¸à¸¸à¸¥ à¸£à¸«à¸±à¸ªà¸à¸™à¸±à¸à¸‡à¸²à¸™ à¸£à¸¹à¸›à¸–à¹ˆà¸²à¸¢<br>
à¹€à¸à¸·à¹ˆà¸­à¸§à¸±à¸•à¸–à¸¸à¸›à¸£à¸°à¸ªà¸‡à¸„à¹Œà¹ƒà¸™à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸´à¸—à¸˜à¸´à¹Œ à¸”à¸¹à¹à¸¥à¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢ à¹à¸¥à¸°à¸šà¸£à¸´à¸«à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£à¸à¸²à¸£à¹€à¸‚à¹‰à¸²â€“à¸­à¸­à¸à¸•à¸²à¸¡à¸¡à¸²à¸•à¸£à¸à¸²à¸£à¸‚à¸­à¸‡à¸šà¸£à¸´à¸©à¸±à¸—à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™<br><br>
à¸à¸²à¸£à¸à¸”à¸›à¸¸à¹ˆà¸¡ "à¸ªà¸£à¹‰à¸²à¸‡ QR Code" à¸–à¸·à¸­à¸§à¹ˆà¸²à¸—à¹ˆà¸²à¸™à¹„à¸”à¹‰à¸­à¹ˆà¸²à¸™ à¸£à¸±à¸šà¸—à¸£à¸²à¸š à¹à¸¥à¸° à¹ƒà¸«à¹‰à¸„à¸§à¸²à¸¡à¸¢à¸´à¸™à¸¢à¸­à¸¡ à¸•à¸²à¸¡à¸à¸£à¸°à¸£à¸²à¸Šà¸šà¸±à¸à¸à¸±à¸•à¸´à¸„à¸¸à¹‰à¸¡à¸„à¸£à¸­à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸§à¸™à¸šà¸¸à¸„à¸„à¸¥ à¸.à¸¨. 2562`,
    consent: "à¸‰à¸±à¸™à¸¢à¸­à¸¡à¸£à¸±à¸šà¹à¸¥à¸°à¹ƒà¸«à¹‰à¸„à¸§à¸²à¸¡à¸¢à¸´à¸™à¸¢à¸­à¸¡à¸•à¸²à¸¡ PDPA",
    card_subtitle: "à¸à¸£à¸“à¸µ 3.2.2 - à¸à¸™à¸±à¸à¸‡à¸²à¸™à¸à¸±à¸à¸­à¸²à¸¨à¸±à¸¢à¸ à¸²à¸¢à¸™à¸­à¸",
    name_label: "à¸Šà¸·à¹ˆà¸­",
    code_label: "à¸£à¸«à¸±à¸ª",
    dept_label: "à¹à¸œà¸™à¸",
    company_label: "à¸šà¸£à¸´à¸©à¸±à¸—",
    qr_title: "QR Code à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š",
    qr_hint: "à¹à¸ªà¸”à¸‡à¸•à¹ˆà¸­à¹€à¸ˆà¹‰à¸²à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸£à¸±à¸à¸©à¸²à¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢<br><strong>à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸£à¸šà¸–à¹‰à¸§à¸™à¸–à¸²à¸§à¸£</strong>",
    status_title: "âœ… à¸šà¸±à¸•à¸£à¸à¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™",
    status_text: "à¸à¸´à¸¡à¸à¹Œà¸«à¸£à¸·à¸­à¸šà¸±à¸™à¸—à¸¶à¸à¸«à¸™à¹‰à¸²à¸ˆà¸­à¹€à¸à¸·à¹ˆà¸­à¹à¸ªà¸”à¸‡à¸•à¹ˆà¸­ à¸£à¸›à¸ .",
    new_card: "à¸ªà¸£à¹‰à¸²à¸‡à¸šà¸±à¸•à¸£à¹ƒà¸«à¸¡à¹ˆ"
  },
  mm: {
    title: "á€…á€€á€ºá€›á€¯á€¶á€•á€¼á€„á€ºá€• á€‘á€½á€€á€ºá€á€½á€„á€·á€ºá€á€±á€¬á€„á€ºá€¸",
    subtitle: "á€¡á€á€¼á€±á€¡á€”á€± 3.2.2 - á€•á€¼á€„á€ºá€•á€”á€±á€‘á€­á€¯á€„á€ºá€á€° á€á€”á€ºá€‘á€™á€ºá€¸",
    name: "á€¡á€™á€Šá€º",
    code: "á€á€”á€ºá€‘á€™á€ºá€¸á€”á€¶á€•á€«á€á€º",
    company: "á€€á€¯á€™á€¹á€•á€á€®",
    dept: "á€Œá€¬á€”",
    photo: "á€“á€¬á€•á€¯á€¶",
    generate: "á€€á€á€ºá€–á€”á€ºá€á€®á€¸",
    pdpa_title: "PDPA - á€•á€¯á€‚á€¹á€‚á€œá€ºá€›á€±á€¸á€€á€­á€¯á€šá€ºá€›á€±á€¸á€¡á€á€»á€€á€ºá€¡á€œá€€á€º",
    pdpa_text: `á€€á€¯á€™á€¹á€•á€á€®á€á€Šá€º á€€á€­á€¯á€šá€ºá€›á€±á€¸á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€‘á€­á€”á€ºá€¸á€á€»á€¯á€•á€ºá€á€°á€¡á€–á€¼á€…á€º á€á€„á€ºá á€€á€­á€¯á€šá€ºá€›á€±á€¸á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€…á€¯á€†á€±á€¬á€„á€ºá€¸áŠ á€¡á€á€¯á€¶á€¸á€•á€¼á€¯áŠ á€œá€¯á€•á€ºá€†á€±á€¬á€„á€ºá€™á€Šá€º á€¡á€™á€Šá€ºáŠ á€á€”á€ºá€‘á€™á€ºá€¸á€”á€¶á€•á€«á€á€ºáŠ á€“á€¬á€•á€¯á€¶<br>
á€á€„á€·á€ºá€á€½á€„á€·á€ºá€•á€¼á€¯á€á€»á€€á€ºá€…á€…á€ºá€†á€±á€¸áŠ á€œá€¯á€¶á€á€¼á€¯á€¶á€›á€±á€¸ á€…á€®á€™á€¶á€á€”á€·á€ºá€á€½á€²á€›á€”á€ºá€”á€¾á€„á€·á€º á€€á€¯á€™á€¹á€•á€á€® á€…á€Šá€ºá€¸á€™á€»á€‰á€ºá€¸á€™á€»á€¬á€¸á€¡á€á€­á€¯á€„á€ºá€¸ á€á€„á€ºá€›á€±á€¬á€€á€ºá€…á€®á€™á€¶á€›á€”á€ºá€á€¬ á€›á€Šá€ºá€›á€½á€šá€ºá€á€Šá€º<br><br>
"QR Code á€‘á€¯á€á€ºá€œá€¯á€•á€ºá€›á€”á€º" á€á€œá€¯á€á€ºá€”á€¾á€­á€•á€ºá€á€¼á€„á€ºá€¸á€–á€¼á€„á€·á€º á€á€„á€ºá€á€Šá€º PDPA á€¥á€•á€’á€±á€¡á€› á€”á€¬á€¸á€œá€Šá€ºá€•á€¼á€®á€¸ á€á€½á€„á€·á€ºá€•á€¼á€¯á€á€»á€€á€ºá€•á€±á€¸á€á€Šá€º`,
    consent: "PDPA á€¡á€› á€œá€€á€ºá€á€¶á€•á€¼á€®á€¸ á€á€½á€„á€·á€ºá€•á€¼á€¯á€á€»á€€á€ºá€•á€±á€¸",
    card_subtitle: "á€¡á€á€¼á€±á€¡á€”á€± 3.2.2 - á€•á€¼á€„á€ºá€•á€”á€±á€‘á€­á€¯á€„á€ºá€á€°",
    name_label: "á€¡á€™á€Šá€º",
    code_label: "á€”á€¶á€•á€«á€á€º",
    dept_label: "á€Œá€¬á€”",
    company_label: "á€€á€¯á€™á€¹á€•á€á€®",
    qr_title: "á€…á€…á€ºá€†á€±á€¸á€›á€”á€º QR Code",
    qr_hint: "á€œá€¯á€¶á€á€¼á€¯á€¶á€›á€±á€¸á€á€”á€ºá€‘á€™á€ºá€¸á€‘á€¶ á€•á€¼á€•á€«<br><strong>á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€•á€¼á€Šá€·á€ºá€…á€¯á€¶á€á€Šá€º</strong>",
    status_title: "âœ… á€€á€á€ºá€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€›á€”á€ºá€¡á€†á€„á€ºá€á€„á€·á€º",
    status_text: "á€•á€›á€„á€·á€ºá€œá€¯á€•á€º á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º á€™á€»á€€á€ºá€”á€¾á€¬á€•á€¼á€„á€ºá€á€­á€™á€ºá€¸á€•á€«",
    new_card: "á€€á€á€ºá€¡á€á€…á€ºá€–á€”á€ºá€á€®á€¸"
  },
  km: {
    title: "áŸáŸ’á“á¾áŸá»áŸ†á…á¶á”áŸ‹á¢á¶ášá˜áŸ’á˜ááŸá…áŸá‰á€áŸ’ášáŸ…ááŸ†á”á“áŸ‹",
    subtitle: "á€ášáá¸ 3.2.2 - á”á»á‚áŸ’á‚á›á·á€ášáŸáŸ‹á“áŸ…áá¶á„á€áŸ’ášáŸ…",
    name: "áˆáŸ’á˜áŸ„áŸ‡-á“á¶á˜",
    code: "á€á¼áŠá”á»á‚áŸ’á‚á›á·á€",
    company: "á€áŸ’ášá»á˜á áŸŠá»á“",
    dept: "á“á¶á™á€áŠáŸ’á‹á¶á“",
    photo: "ášá¼á”áá",
    generate: "á”á„áŸ’á€á¾áá€á¶á",
    pdpa_title: "PDPA - á‚áŸ„á›á“á™áŸ„á”á¶á™á¯á€á‡á“á—á¶á–",
    pdpa_text: `á€áŸ’ášá»á˜á áŸŠá»á“á€áŸ’á“á»á„á“á¶á˜á‡á¶á¢áŸ’á“á€á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á‘á·á“áŸ’á“á“áŸá™á•áŸ’á‘á¶á›áŸ‹ááŸ’á›á½á“ á“á¹á„á”áŸ’ášá˜á¼á› á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹ á“á·á„áŠáŸ†áá¾ášá€á¶ášá‘á·á“áŸ’á“á“áŸá™á•áŸ’á‘á¶á›áŸ‹ááŸ’á›á½á“ášá”áŸáŸ‹á¢áŸ’á“á€ ášá½á˜á˜á¶á“ áˆáŸ’á˜áŸ„áŸ‡ á€á¼áŠá”á»á‚áŸ’á‚á›á·á€ ášá¼á”áá<br>
áŸá˜áŸ’ášá¶á”áŸ‹á‚áŸ„á›á”áŸ†áá„ááŸ’ášá½áá–á·á“á·ááŸ’á™áŸá·á‘áŸ’á’á· á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„áŸá»áœááŸ’áá·á—á¶á– á“á·á„á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á€á¶ášá…á¼á›-á…áŸá‰áá¶á˜áœá·á’á¶á“á€á¶ášá€áŸ’ášá»á˜á áŸŠá»á“ááŸ‚á”áŸ‰á»ááŸ’ááŸ„áŸ‡<br><br>
á€á¶ášá…á»á…á”áŸŠá¼áá»á„ "á”á„áŸ’á€á¾á QR Code" ááŸ’ášá¼áœá”á¶á“á…á¶ááŸ‹á‘á»á€áá¶á¢áŸ’á“á€á”á¶á“á¢á¶á“á™á›áŸ‹áŠá¹á„ á“á·á„á™á›áŸ‹á–áŸ’ášá˜áá¶á˜á…áŸ’á”á¶á”áŸ‹á€á¶ášá–á¶ášá‘á·á“áŸ’á“á“áŸá™á•áŸ’á‘á¶á›áŸ‹ááŸ’á›á½á“ á†áŸ’á“á¶áŸ†áŸ¢áŸ áŸ¢áŸ¢`,
    consent: "ááŸ’á‰á»áŸ†á™á›áŸ‹á–áŸ’ášá˜á“á·á„á•áŸ’áá›áŸ‹á€á¶ášá™á›áŸ‹á–áŸ’ášá˜áá¶á˜ PDPA",
    card_subtitle: "á€ášáá¸ 3.2.2 - á”á»á‚áŸ’á‚á›á·á€ášáŸáŸ‹á“áŸ…áá¶á„á€áŸ’ášáŸ…",
    name_label: "áˆáŸ’á˜áŸ„áŸ‡",
    code_label: "á€á¼áŠ",
    dept_label: "á“á¶á™á€áŠáŸ’á‹á¶á“",
    company_label: "á€áŸ’ášá»á˜á áŸŠá»á“",
    qr_title: "QR Code áŸá˜áŸ’ášá¶á”áŸ‹ááŸ’ášá½áá–á·á“á·ááŸ’á™",
    qr_hint: "á”á„áŸ’á á¶á‰áŠá›áŸ‹á˜á“áŸ’ááŸ’ášá¸áŸá»áœááŸ’áá·á—á¶á–<br><strong>á–áŸááŸŒá˜á¶á“á–áŸá‰á›áŸá‰á“á·ášá“áŸ’áášá—á¶á–</strong>",
    status_title: "âœ… á€á¶áááŸ’ášáŸ€á˜ášá½á…áŸá˜áŸ’ášá¶á”áŸ‹á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹",
    status_text: "á”áŸ„áŸ‡á–á»á˜áŸ’á–á¬ášá€áŸ’áŸá¶á‘á»á€á¢áŸá€áŸ’ášá„áŸ‹",
    new_card: "á”á„áŸ’á€á¾áá€á¶áááŸ’á˜á¸"
  }
};

const companies = [
  "à¸šà¸£à¸´à¸©à¸±à¸— à¸­à¸µ.à¸„à¸´à¸§. à¸£à¸±à¸šà¹€à¸šà¸­à¸£à¹Œ à¸ˆà¸³à¸à¸±à¸” (EQO)",
  "à¸šà¸£à¸´à¸©à¸±à¸— à¹„à¸—à¸¢à¸­à¸µà¸ªà¹€à¸—à¸´à¸£à¹Œà¸™ à¸­à¸´à¸™à¹‚à¸™à¹€à¸§à¸Šà¸±à¹ˆà¸™ à¸ˆà¸³à¸à¸±à¸” (TEI)",
  "à¸šà¸£à¸´à¸©à¸±à¸— à¹„à¸—à¸¢à¸­à¸µà¸ªà¹€à¸—à¸´à¸£à¹Œà¸™ à¸£à¸±à¸šà¹€à¸šà¸­à¸£à¹Œ à¸ˆà¸³à¸à¸±à¸” (TER)",
  "à¸šà¸£à¸´à¸©à¸±à¸— à¸­à¸µà¸ªà¹€à¸—à¸´à¸£à¹Œà¸™ à¸›à¸²à¸¥à¹Œà¸¡ à¸­à¸­à¸¢à¸¥à¹Œ à¸ˆà¸³à¸à¸±à¸” (EPO)",
  "à¸šà¸£à¸´à¸©à¸±à¸— à¹„à¸—à¸¢à¸­à¸µà¸ªà¹€à¸—à¸´à¸£à¹Œà¸™ à¸—à¹‰à¸­à¸›à¸‹à¸µà¸”à¸ªà¹Œ à¸­à¸­à¸¢à¸¥à¹Œ à¸ˆà¸³à¸à¸±à¸” (TETSO)",
  "à¸šà¸£à¸´à¸©à¸±à¸— à¹„à¸—à¸¢à¸­à¸µà¸ªà¹€à¸—à¸´à¸£à¹Œà¸™ à¹„à¸šà¹‚à¸­ à¸à¸²à¸§à¹€à¸§à¸­à¸£à¹Œ à¸ˆà¸³à¸à¸±à¸” (à¸¡à¸«à¸²à¸Šà¸™) (TEBP)",
  "à¸šà¸£à¸´à¸©à¸±à¸— à¹„à¸—à¸¢à¸­à¸µà¸ªà¹€à¸—à¸´à¸£à¹Œà¸™ à¹‚à¸¥à¸ˆà¸´à¸ªà¸•à¸´à¸à¸ªà¹Œ à¸ˆà¸³à¸à¸±à¸” (TEL)",
  "à¸šà¸£à¸´à¸©à¸±à¸— à¹„à¸—à¸¢à¸­à¸µà¸ªà¹€à¸—à¸´à¸£à¹Œà¸™ à¸­à¸´à¸™à¸”à¸±à¸ªà¹€à¸•à¸£à¸µà¸¢à¸¥ à¹à¸¥à¸™à¸”à¹Œ à¸ˆà¸³à¸à¸±à¸” (TEIL)"
];

let currentLang = 'th';
let employeeData = JSON.parse(localStorage.getItem('tegEmployeeData')) || [];
let isGuardMode = false;
let video, canvas, ctx;
let currentScannedKey = null;

// ğŸ”¥ à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸«à¸¥à¸±à¸à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
document.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸ”¥ TEG Guard 3.2.2 Loaded');
  setupLanguageSwitcher();
  setupGuardMode();
  showForm(document.getElementById('main-container'));
  
  // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š URL parameter à¸ªà¸³à¸«à¸£à¸±à¸š QR scan à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
  const urlParams = new URLSearchParams(window.location.search);
  const key = urlParams.get('key');
  if (key && isGuardMode) {
    showEmployeeByKey(key);
  }
});

function setupLanguageSwitcher() {
  document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      currentLang = this.dataset.lang;
      document.querySelector('.lang-btn.active').classList.remove('active');
      this.classList.add('active');
      if (!isGuardMode) {
        showForm(document.getElementById('main-container'));
      }
    });
  });
}

function setupGuardMode() {
  const guardBtn = document.getElementById('guardBtn');
  const modal = document.getElementById('guardModal');
  const cancelBtn = document.getElementById('cancelLogin');
  const loginBtn = document.getElementById('confirmLogin');
  
  guardBtn.addEventListener('click', (e) => {
    e.preventDefault();
    modal.style.display = 'flex';
  });
  
  cancelBtn.addEventListener('click', (e) => {
    e.preventDefault();
    modal.style.display = 'none';
    document.getElementById('guardPassword').value = '';
  });
  
  loginBtn.addEventListener('click', (e) => {
    e.preventDefault();
    const password = document.getElementById('guardPassword').value;
    if (password === 'Teg2025+') {
      modal.style.display = 'none';
      document.getElementById('guardPassword').value = '';
      isGuardMode = true;
      document.getElementById('guardPanel').style.display = 'block';
      document.getElementById('main-container').style.display = 'none';
      initQRScanner();
      loadReport();
    } else {
      alert('âŒ à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡');
      document.getElementById('guardPassword').value = '';
    }
  });
  
  // Tab buttons
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      document.querySelector('.tab-btn.active').classList.remove('active');
      this.classList.add('active');
      document.querySelectorAll('.scan-section, .report-section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(this.dataset.tab + 'Tab').classList.add('active');
      if (this.dataset.tab === 'scan') initQRScanner();
      if (this.dataset.tab === 'report') loadReport();
    });
  });
  
  document.getElementById('exportExcel').addEventListener('click', exportToExcel);
  document.getElementById('qrImageInput').addEventListener('change', handleQrImageUpload);
  
  // Guard confirm button (dynamic)
  document.addEventListener('click', function(e) {
    if (e.target.id === 'guardConfirmBtn') {
      guardConfirmAction();
    }
  });
}

function showForm(container) {
  const t = translations[currentLang];
  container.innerHTML = `
    <h1>${t.title}</h1>
    <p style="text-align:center;color:#6b7280;font-size:0.95rem;margin-bottom:24px;">${t.subtitle}</p>
    <form id="employeeForm" class="form-section">
      <div class="form-group">
        <label>${t.name} <span style="color:#ef4444;">*</span></label>
        <input type="text" id="name1" required placeholder="à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸Šà¸·à¹ˆà¸­-à¸™à¸²à¸¡à¸ªà¸à¸¸à¸¥">
      </div>
      <div class="form-group">
        <label>${t.code} <span style="color:#ef4444;">*</span></label>
        <input type="text" id="code1" required placeholder="à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸£à¸«à¸±à¸ªà¸à¸™à¸±à¸à¸‡à¸²à¸™">
      </div>
      <div class="form-group">
        <label>${t.company} <span style="color:#ef4444;">*</span></label>
        <select id="company1" required>
          <option value="">-- à¹€à¸¥à¸·à¸­à¸à¸šà¸£à¸´à¸©à¸±à¸— --</option>
          ${companies.map(c => `<option value="${c}">${c}</option>`).join('')}
        </select>
      </div>
      <div class="form-group">
        <label>${t.dept} <span style="color:#ef4444;">*</span></label>
        <input type="text" id="dept1" required placeholder="à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¹à¸œà¸™à¸">
      </div>
      <div class="pdpa-notice">
        <h4>${t.pdpa_title}</h4>
        <div>${t.pdpa_text}</div>
        <label class="pdpa-checkbox">
          <input type="checkbox" id="pdpa-consent">
          <span>${t.consent} <span style="color:#ef4444;">*</span></span>
        </label>
      </div>
      <div class="form-group">
        <label>${t.photo} <span style="color:#ef4444;">*</span></label>
        <input type="file" id="photo1" accept="image/*" capture="environment" required>
        <img id="preview1" style="display:none;">
      </div>
      <button type="submit" class="main-button generate-button" id="generateBtn" disabled>
        ğŸ“± ${t.generate}
      </button>
    </form>
  `;
  
  // ğŸ”¥ à¹à¸à¹‰à¸›à¸±à¸à¸«à¸² Mobile - Setup events à¹ƒà¸«à¸¡à¹ˆà¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡
  setupFormEvents();
}

function setupFormEvents() {
  const photoInput = document.getElementById('photo1');
  const preview = document.getElementById('preview1');
  const form = document.getElementById('employeeForm');
  const generateBtn = document.getElementById('generateBtn');
  
  function checkFormReady() {
    try {
      const name = document.getElementById('name1').value.trim();
      const code = document.getElementById('code1').value.trim();
      const company = document.getElementById('company1').value;
      const dept = document.getElementById('dept1').value.trim();
      const pdpa = document.getElementById('pdpa-consent').checked;
      const photo = photoInput.files && photoInput.files.length > 0;
      
      const isReady = name && code && company && dept && pdpa && photo;
      generateBtn.disabled = !isReady;
      generateBtn.textContent = isReady ? 'âœ… à¸ªà¸£à¹‰à¸²à¸‡à¸šà¸±à¸•à¸£à¸à¸™à¸±à¸à¸‡à¸²à¸™' : 'ğŸ“± à¸ªà¸£à¹‰à¸²à¸‡à¸šà¸±à¸•à¸£à¸à¸™à¸±à¸à¸‡à¸²à¸™';
      
      console.log('Form check:', {name: !!name, code: !!code, company: !!company, dept: !!dept, pdpa, photo});
    } catch(e) {
      console.error('Form check error:', e);
    }
  }
  
  // Photo preview
  photoInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸‚à¸™à¸²à¸”à¹„à¸Ÿà¸¥à¹Œ (à¸ªà¸¹à¸‡à¸ªà¸¸à¸” 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('âš ï¸ à¸£à¸¹à¸›à¹ƒà¸«à¸à¹ˆà¹€à¸à¸´à¸™à¹„à¸› (à¸ªà¸¹à¸‡à¸ªà¸¸à¸” 5MB)');
        photoInput.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e2) {
        preview.src = e2.target.result;
        preview.style.display = 'block';
        checkFormReady();
      };
      reader.onerror = function() {
        alert('âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸­à¹ˆà¸²à¸™à¸£à¸¹à¸›à¹„à¸”à¹‰');
        photoInput.value = '';
      };
      reader.readAsDataURL(file);
    } else {
      preview.style.display = 'none';
      checkFormReady();
    }
  });
  
  // Input events
  ['name1', 'code1', 'dept1'].forEach(id => {
    const input = document.getElementById(id);
    if (input) {
      input.addEventListener('input', checkFormReady);
      input.addEventListener('change', checkFormReady);
    }
  });
  
  const companySelect = document.getElementById('company1');
  if (companySelect) {
    companySelect.addEventListener('change', checkFormReady);
  }
  
  const pdpaCheckbox = document.getElementById('pdpa-consent');
  if (pdpaCheckbox) {
    pdpaCheckbox.addEventListener('change', checkFormReady);
  }
  
  // ğŸ”¥ à¸›à¸¸à¹ˆà¸¡ Submit - à¹à¸à¹‰à¸›à¸±à¸à¸«à¸² Mobile Touch
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    e.stopPropagation();
    createProfessionalCard();
  });
  
  // à¸›à¸¸à¹ˆà¸¡à¸à¸”à¸•à¸£à¸‡à¹† (backup à¸ªà¸³à¸«à¸£à¸±à¸š mobile)
  generateBtn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    if (!this.disabled) {
      createProfessionalCard();
    }
  });
  
  // Initial check
  checkFormReady();
}

function createProfessionalCard() {
  try {
    const name = document.getElementById('name1').value.trim();
    const code = document.getElementById('code1').value.trim();
    const company = document.getElementById('company1').value;
    const dept = document.getElementById('dept1').value.trim();
    const file = document.getElementById('photo1').files[0];
    const t = translations[currentLang];
    
    if (!file) {
      alert('âŒ à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›à¸–à¹ˆà¸²à¸¢');
      return;
    }
    
    const generateBtn = document.getElementById('generateBtn');
    generateBtn.disabled = true;
    generateBtn.textContent = 'â³ à¸à¸³à¸¥à¸±à¸‡à¸ªà¸£à¹‰à¸²à¸‡...';
    
    const reader = new FileReader();
    reader.onload = function(e) {
      const photoData = e.target.result;
      const key = 'EMP_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      const employee = {
        key, name, code, company, dept, photoData,
        timestamp: new Date().toISOString(),
        guardConfirmTime: null,
        scanLogs: []
      };
      
      employeeData.unshift(employee);
      localStorage.setItem('tegEmployeeData', JSON.stringify(employeeData));
      
      console.log('âœ… Card created:', key);
      showEmployeeCard(name, code, company, dept, photoData, key, t);
    };
    reader.onerror = function() {
      alert('âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸­à¹ˆà¸²à¸™à¸£à¸¹à¸›à¹„à¸”à¹‰');
      generateBtn.disabled = false;
      generateBtn.textContent = 'ğŸ“± à¸ªà¸£à¹‰à¸²à¸‡à¸šà¸±à¸•à¸£à¸à¸™à¸±à¸à¸‡à¸²à¸™';
    };
    reader.readAsDataURL(file);
  } catch(e) {
    console.error('Create card error:', e);
    alert('âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸” à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ');
  }
}

function showEmployeeCard(name, code, company, dept, photoData, key, t) {
  const container = document.getElementById('main-container');
  container.innerHTML = `
    <div class="card-section">
      <div class="employee-card">
        <div class="card-header">
          <h3 class="card-company">${company}</h3>
          <p class="card-subtitle">${t.card_subtitle}</p>
        </div>
        <div class="card-body">
          <img src="${photoData}" class="card-photo" alt="à¸£à¸¹à¸›à¸à¸™à¸±à¸à¸‡à¸²à¸™" loading="lazy">
          <div class="card-details">
            <div class="detail-row">
              <span class="detail-label">${t.name_label}</span>
              <span class="detail-value">${name}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">${t.code_label}</span>
              <span class="detail-value">${code}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">${t.dept_label}</span>
              <span class="detail-value">${dept}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">${t.company_label}</span>
              <span class="detail-value">${company}</span>
            </div>
          </div>
        </div>
      </div>
      <div class="qr-container">
        <div class="qr-title">${t.qr_title}</div>
        <canvas id="qr-canvas"></canvas>
        <div class="qr-hint">${t.qr_hint}</div>
      </div>
      <div class="status-info">
        <h3>${t.status_title}</h3>
        <p>${t.status_text}</p>
      </div>
      <button class="main-button" onclick="location.reload()" style="background:#6b7280;color:white;">
        ğŸ”„ ${t.new_card}
      </button>
    </div>
  `;
  
  // à¸ªà¸£à¹‰à¸²à¸‡ QR Code
  setTimeout(() => {
    try {
      const canvas = document.getElementById('qr-canvas');
      if (canvas) {
        const qrUrl = `${window.location.origin}${window.location.pathname}?key=${key}`;
        new QRious({ 
          element: canvas, 
          value: qrUrl, 
          size: 240, 
          level: 'H' 
        });
        console.log('âœ… QR Generated:', qrUrl);
      }
    } catch(e) {
      console.error('QR Error:', e);
    }
  }, 200);
}

/* ====== à¸£à¸›à¸ . Scanner ====== */
function initQRScanner() {
  if (video && video.srcObject) return;
  
  video = document.getElementById('video');
  canvas = document.getElementById('canvas');
  ctx = canvas.getContext('2d');
  
  navigator.mediaDevices.getUserMedia({ 
    video: { 
      facingMode: 'environment',
      width: { ideal: 1280 },
      height: { ideal: 720 }
    } 
  })
  .then(stream => {
    video.srcObject = stream;
    video.setAttribute('playsinline', true);
    video.play();
    requestAnimationFrame(tick);
  })
  .catch(err => {
    console.error('Camera error:', err);
    document.getElementById('scanTab').innerHTML += 
      '<p style="color:red;text-align:center;padding:20px;">ğŸ“± à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡à¹„à¸”à¹‰<br>à¸à¸£à¸¸à¸“à¸²à¹ƒà¸«à¹‰à¸ªà¸´à¸—à¸˜à¸´à¹Œà¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸à¸¥à¹‰à¸­à¸‡</p>';
  });
}

function tick() {
  if (!isGuardMode || !video || video.readyState !== video.HAVE_ENOUGH_DATA) {
    requestAnimationFrame(tick);
    return;
  }
  
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const code = jsQR(imageData.data, imageData.width, imageData.height);
  
  if (code && code.data.includes('?key=')) {
    const url = new URL(code.data);
    const key = url.searchParams.get('key');
    if (key) {
      console.log('ğŸ” QR Scanned:', key);
      showEmployeeByKey(key);
      return; // à¸«à¸¢à¸¸à¸” scan à¸Šà¸±à¹ˆà¸§à¸„à¸£à¸²à¸§
    }
  }
  
  requestAnimationFrame(tick);
}

function handleQrImageUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(ev) {
    const img = new Image();
    img.onload = function() {
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      
      if (code && code.data.includes('?key=')) {
        const url = new URL(code.data);
        const key = url.searchParams.get('key');
        if (key) {
          showEmployeeByKey(key);
        } else {
          alert('âŒ à¹„à¸¡à¹ˆà¸à¸š key à¹ƒà¸™ QR à¸™à¸µà¹‰');
        }
      } else {
        alert('âŒ à¸­à¹ˆà¸²à¸™ QR à¸ˆà¸²à¸à¸£à¸¹à¸›à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ');
      }
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
}

function showEmployeeByKey(key) {
  const emp = employeeData.find(e => e.key === key);
  if (!emp) { 
    alert('âŒ à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸™à¸±à¸à¸‡à¸²à¸™à¹ƒà¸™à¸£à¸°à¸šà¸š');
    return; 
  }
  
  // à¸šà¸±à¸™à¸—à¸¶à¸ log à¸à¸²à¸£à¸ªà¹à¸à¸™
  const scanLog = {
    scanTime: new Date().toISOString(),
    scanDate: new Date().toLocaleDateString('th-TH'),
    scanTimeLocal: new Date().toLocaleString('th-TH')
  };
  if (!emp.scanLogs) emp.scanLogs = [];
  emp.scanLogs.unshift(scanLog);
  
  currentScannedKey = key;
  
  document.getElementById('scan-photo').src = emp.photoData;
  document.getElementById('scan-name').textContent = emp.name;
  document.getElementById('scan-code').textContent = emp.code;
  document.getElementById('scan-company').textContent = emp.company;
  document.getElementById('scan-dept').textContent = emp.dept;
  document.getElementById('scan-time').textContent = new Date(emp.timestamp).toLocaleString('th-TH');
  document.getElementById('scan-guard-time').textContent = emp.guardConfirmTime
    ? new Date(emp.guardConfirmTime).toLocaleString('th-TH') : '-';
    
  document.getElementById('scan-result').style.display = 'block';
  localStorage.setItem('tegEmployeeData', JSON.stringify(employeeData));
}

function guardConfirmAction() {
  if (!currentScannedKey) { 
    alert('âŒ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ QR');
    return; 
  }
  
  const index = employeeData.findIndex(e => e.key === currentScannedKey);
  if (index === -1) { 
    alert('âŒ à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸™à¸±à¸à¸‡à¸²à¸™');
    return; 
  }
  
  const now = new Date().toISOString();
  const confirmLog = {
    scanTime: now,
    scanDate: new Date().toLocaleDateString('th-TH'),
    scanTimeLocal: new Date().toLocaleString('th-TH'),
    guardConfirmed: true
  };
  
  employeeData[index].scanLogs.unshift(confirmLog);
  employeeData[index].guardConfirmTime = now;
  
  localStorage.setItem('tegEmployeeData', JSON.stringify(employeeData));
  document.getElementById('scan-guard-time').textContent = new Date(now).toLocaleString('th-TH');
  
  alert('âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸§à¸¥à¸²à¸¢à¸·à¸™à¸¢à¸±à¸™à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢!\nğŸ“Š à¸­à¸±à¸à¹€à¸”à¸—à¸£à¸²à¸¢à¸‡à¸²à¸™à¹à¸¥à¹‰à¸§');
  loadReport();
  document.getElementById('scan-result').style.display = 'none';
  currentScannedKey = null;
}

function loadReport() {
  const tbody = document.querySelector('#reportTable tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  employeeData.slice(0, 50).forEach(emp => { // à¸ˆà¸³à¸à¸±à¸” 50 à¸£à¸²à¸¢à¸à¸²à¸£à¸¥à¹ˆà¸²à¸ªà¸¸à¸”
    const tr = document.createElement('tr');
    const totalScans = emp.scanLogs?.length || 0;
    tr.innerHTML = `
      <td class="photo-cell"><img src="${emp.photoData}" alt="" loading="lazy"></td>
      <td>${emp.name}</td>
      <td>${emp.code}</td>
      <td>${emp.company.substring(0,20)}${emp.company.length > 20 ? '...' : ''}</td>
      <td>${emp.dept.substring(0,15)}${emp.dept.length > 15 ? '...' : ''}</td>
      <td>${new Date(emp.timestamp).toLocaleString('th-TH')}</td>
      <td>${emp.guardConfirmTime ? new Date(emp.guardConfirmTime).toLocaleString('th-TH') : '-'}</td>
    `;
    tbody.appendChild(tr);
  });
}

function exportToExcel() {
  let csv = '\uFEFFà¸Šà¸·à¹ˆà¸­,à¸£à¸«à¸±à¸ª,à¸šà¸£à¸´à¸©à¸±à¸—,à¹à¸œà¸™à¸,à¸ªà¸£à¹‰à¸²à¸‡à¸šà¸±à¸•à¸£,à¸£à¸›à¸ .à¸¢à¸·à¸™à¸¢à¸±à¸™,à¸ªà¹à¸à¸™à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”\n';
  employeeData.forEach(emp => {
    const totalScans = emp.scanLogs?.length || 0;
    const scanDetails = emp.scanLogs?.slice(0,5).map(log => 
      `${log.scanTimeLocal}${log.guardConfirmed ? ' (à¸¢à¸·à¸™à¸¢à¸±à¸™)' : ''}`
    ).join('; ') || '';
    csv += `"${emp.name}","${emp.code}","${emp.company}","${emp.dept}","${new Date(emp.timestamp).toLocaleString('th-TH')}","${emp.guardConfirmTime ? new Date(emp.guardConfirmTime).toLocaleString('th-TH') : ''}","${totalScans} (${scanDetails})"\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `TEG_322_Report_${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// PWA Support
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(() => {});
}
</script>
</body>
</html>
