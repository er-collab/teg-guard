<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>TEG 3.2.2 - ‡∏ö‡∏±‡∏ï‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');

* { box-sizing: border-box; touch-action: manipulation; }
body {
  font-family: 'Sarabun', -apple-system, BlinkMacSystemFont, sans-serif;
  margin: 0;
  background-image: url('https://img2.pic.in.th/pic/29a2bfcf779db2329.jpg');
  background-size: cover;
  background-position: center;
  background-attachment: fixed;
  min-height: 100vh;
  padding: 10px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  color: #2c3e50;
  -webkit-tap-highlight-color: transparent;
}

.lang-switcher {
  position: absolute;
  top: 15px;
  right: 15px;
  display: flex;
  gap: 6px;
  z-index: 1000;
}
.lang-btn {
  width: 40px;
  height: 40px;
  border: 2px solid rgba(255,255,255,0.3);
  border-radius: 10px;
  background: rgba(255,255,255,0.9);
  color: #374151;
  font-weight: 600;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s ease;
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  touch-action: manipulation;
}
.lang-btn.active {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  border-color: #3b82f6;
}

.container {
  background: rgba(255, 255, 255, 0.92);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 20px;
  padding: 20px 16px;
  width: 100%;
  max-width: 420px;
  max-height: 92vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
  position: relative;
  margin-top: 70px;
}

h1 {
  text-align: center;
  color: #1a1a1a;
  font-weight: 600;
  font-size: clamp(1.2rem, 4vw, 1.4rem);
  margin: 0 0 12px 0;
}

.form-section, .card-section { display: flex; flex-direction: column; gap: 16px; }

.form-group { display: flex; flex-direction: column; gap: 6px; }
label { font-weight: 500; color: #374151; font-size: 0.9rem; }
select, input[type="text"], input[type="file"] {
  width: 100%;
  padding: 12px 14px;
  border: 2px solid #e5e7eb;
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.8);
  font-family: inherit;
  font-size: 0.95rem;
  color: #1f2937;
  transition: all 0.2s ease;
}
input:focus, select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
input[type="file"]::file-selector-button {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  font-weight: 500;
  cursor: pointer;
  margin-right: 10px;
}

.pdpa-notice {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  border: 1px solid #f59e0b;
  border-radius: 10px;
  padding: 12px;
  font-size: 0.8rem;
  line-height: 1.4;
  color: #92400e;
}
.pdpa-notice h4 { color: #b45309; margin: 0 0 6px 0; font-size: 0.9rem; }
.pdpa-checkbox {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  margin-top: 10px;
}

.main-button {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.2s ease;
  touch-action: manipulation;
}
.generate-button {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
}
.generate-button:disabled {
  background: #9ca3af;
  cursor: not-allowed;
}

#preview1 {
  width: 80px;
  height: 100px;
  object-fit: cover;
  border-radius: 8px;
  border: 2px solid #e5e7eb;
  margin-top: 6px;
  display: none;
}

.employee-card {
  background: rgba(255, 255, 255, 0.98);
  border-radius: 16px;
  padding: 0;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
  overflow: hidden;
}

.card-header {
  background: linear-gradient(135deg, #f8fafc, #f1f5f9);
  padding: 16px 20px;
  text-align: center;
  border-bottom: 1px solid rgba(226, 232, 240, 0.8);
}
.card-company {
  font-weight: 600;
  font-size: 1rem;
  color: #1e293b;
  margin: 0 0 2px 0;
}
.card-subtitle {
  font-size: 0.8rem;
  color: #64748b;
  margin: 0;
}

.card-body {
  padding: 16px;
  display: flex;
  gap: 14px;
}
.card-photo {
  width: 80px;
  height: 100px;
  border-radius: 10px;
  object-fit: cover;
  flex-shrink: 0;
  border: 2px solid rgba(255, 255, 255, 0.8);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
}
.card-details {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.detail-row { display: flex; align-items: flex-start; gap: 8px; }
.detail-label {
  font-weight: 600;
  font-size: 0.85rem;
  color: #374151;
  min-width: 50px;
  flex-shrink: 0;
}
.detail-value {
  font-weight: 500;
  font-size: 0.9rem;
  color: #1f2937;
  flex: 1;
}

.qr-container {
  margin-top: 16px;
  padding: 16px;
  background: rgba(255, 255, 255, 0.98);
  border-radius: 14px;
  border: 1px solid rgba(226, 232, 240, 0.8);
  text-align: center;
}
.qr-title {
  font-weight: 600;
  font-size: 0.95rem;
  color: #1f2937;
  margin-bottom: 12px;
}
#qr-canvas {
  width: 200px;
  height: 200px;
  border: 2px solid #f3f4f6;
  border-radius: 12px;
  background: white;
  margin: 0 auto 10px;
}
.qr-hint { font-size: 0.8rem; color: #6b7280; line-height: 1.3; }

.status-info {
  background: linear-gradient(135deg, #ecfdf5, #d1fae5);
  border: 1px solid #a7f3d0;
  border-radius: 10px;
  padding: 12px;
  margin-top: 14px;
  text-align: center;
}
.status-info h3 { color: #166534; font-size: 1rem; margin: 0 0 6px 0; }
.status-info p { color: #047857; margin: 0; font-size: 0.85rem; }

.screenshot-btn {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  margin-top: 10px;
}

@media (max-width: 480px) {
  .container { padding: 16px 12px; margin-top: 80px; }
  .card-body { flex-direction: column; align-items: center; }
  .card-photo { width: 100px; height: 130px; }
  #qr-canvas { width: 180px; height: 180px; }
}

/* ‡∏£‡∏õ‡∏†. */
.guard-settings {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
}
.guard-btn {
  width: 52px;
  height: 52px;
  border-radius: 50%;
  border: 3px solid rgba(255,255,255,0.4);
  background: rgba(255,255,255,0.98);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  transition: all 0.3s ease;
  touch-action: manipulation;
}
.guard-btn svg {
  width: 24px;
  height: 24px;
  fill: #ef4444;
}

.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.8);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  backdrop-filter: blur(5px);
}
.modal {
  background: white;
  border-radius: 18px;
  padding: 20px;
  width: 90%;
  max-width: 360px;
  box-shadow: 0 25px 70px rgba(0,0,0,0.4);
}
.modal h2 { margin: 0 0 10px 0; font-size: 1.1rem; text-align: center; }
.modal input {
  width: 100%;
  padding: 12px;
  border: 2px solid #e5e7eb;
  border-radius: 10px;
  font-size: 0.95rem;
  margin-bottom: 14px;
}
.modal-buttons { display: flex; gap: 10px; }
.btn-small {
  flex: 1;
  padding: 11px;
  border-radius: 10px;
  border: none;
  font-weight: 500;
  cursor: pointer;
}
.btn-cancel { background: #f3f4f6; color: #374151; }
.btn-login { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }

.guard-panel {
  display: none;
  background: rgba(255,255,255,0.95);
  border-radius: 18px;
  padding: 16px;
  margin-top: 80px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.2);
  max-width: 95%;
  width: 100%;
  max-height: 85vh;
  overflow-y: auto;
}
.guard-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
.tab-btn {
  flex: 1;
  padding: 10px;
  border: 2px solid #e5e7eb;
  background: white;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 500;
}
.tab-btn.active {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  border-color: #3b82f6;
}

.scan-section, .report-section { display: none; }
.scan-section.active, .report-section.active { display: block; }

#video {
  width: 100%;
  height: 220px;
  border: 2px solid #e5e7eb;
  border-radius: 10px;
  background: #f9fafb;
}
#canvas { display: none; }

.employee-detail {
  background: linear-gradient(135deg, #ecfdf5, #d1fae5);
  border-radius: 14px;
  padding: 16px;
  border: 1px solid #a7f3d0;
  margin-top: 14px;
}
.employee-photo {
  width: 90px;
  height: 120px;
  object-fit: cover;
  border-radius: 10px;
  margin: 0 auto 12px;
  display: block;
  border: 3px solid white;
  box-shadow: 0 6px 20px rgba(0,0,0,0.12);
}
.detail-grid {
  display: grid;
  grid-template-columns: 1fr 2fr;
  gap: 10px;
  font-size: 0.9rem;
}
.detail-label { font-weight: 600; color: #047857; }

.guard-confirm-btn {
  margin-top: 12px;
  width: 100%;
  padding: 11px;
  border-radius: 10px;
  border: none;
  background: linear-gradient(135deg, #f97316, #ea580c);
  color: white;
  font-weight: 600;
  cursor: pointer;
}

/* üî• ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á */
.report-container {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.report-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.75rem;
  background: white;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}
.report-table th {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  padding: 10px 6px;
  font-weight: 600;
  white-space: nowrap;
  position: sticky;
  top: 0;
  z-index: 10;
}
.report-table td { 
  padding: 8px 6px; 
  border-bottom: 1px solid #e5e7eb;
  vertical-align: top;
}
.report-table tr:hover { background: #f8fafc; }
.photo-cell { width: 50px; text-align: center; }
.photo-cell img {
  width: 35px;
  height: 45px;
  object-fit: cover;
  border-radius: 5px;
}

/* üî• ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡πÅ‡∏Å‡∏ô */
.scan-history {
  max-height: 150px;
  overflow-y: auto;
  padding: 4px;
  background: #f9fafb;
  border-radius: 6px;
  font-size: 0.7rem;
}
.scan-item {
  padding: 4px 6px;
  margin-bottom: 3px;
  background: white;
  border-radius: 4px;
  border-left: 3px solid #3b82f6;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 6px;
}
.scan-item.confirmed {
  border-left-color: #10b981;
  background: #ecfdf5;
}
.scan-time {
  font-weight: 600;
  color: #1f2937;
  white-space: nowrap;
}
.scan-badge {
  background: #10b981;
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.65rem;
  font-weight: 600;
}

@media (max-width: 768px) {
  .report-table {
    font-size: 0.65rem;
  }
  .report-table th, .report-table td {
    padding: 6px 4px;
  }
  .scan-history {
    max-height: 120px;
    font-size: 0.65rem;
  }
}

@media (min-width: 1024px) {
  .guard-panel {
    max-width: 1400px;
  }
  .report-table {
    font-size: 0.85rem;
  }
  .scan-history {
    max-height: 200px;
    font-size: 0.75rem;
  }
}

.export-btn {
  width: 100%;
  padding: 12px;
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 14px;
}

.total-scans {
  display: inline-block;
  background: #3b82f6;
  color: white;
  padding: 3px 8px;
  border-radius: 6px;
  font-weight: 700;
  font-size: 0.85rem;
}
</style>
</head>
<body>

<div class="guard-settings">
  <button class="guard-btn" id="guardBtn" title="‡πÇ‡∏´‡∏°‡∏î ‡∏£‡∏õ‡∏†.">
    <svg viewBox="0 0 24 24">
      <path d="M12 8.5A3.5 3.5 0 1 0 12 15.5 3.5 3.5 0 0 0 12 8.5zm8.94 2.57-1.35-.78a7.1 7.1 0 0 0-.32-1.07l.67-1.43a.75.75 0 0 0-.16-.86l-1.5-1.5a.75.75 0 0 0-.86-.16l-1.43.67c-.35-.13-.71-.24-1.07-.32L14.75 4h-1.5l-.17 1.52c-.36.08-.72.19-1.07.32l-1.43-.67a.75.75 0 0 0-.86.16l-1.5 1.5a.75.75 0 0 0-.16.86l.67 1.43c-.13.35-.24.71-.32 1.07l-1.52.17v1.5l1.52.17c.08.36.19.72.32 1.07l-.67 1.43a.75.75 0 0 0 .16.86l1.5 1.5c.21.21.53.27.8.16l1.43-.67c.35.13.71.24 1.07.32l.17 1.52h1.5l.17-1.52c.36-.08.72-.19 1.07-.32l1.43.67c.27.11.59.05.8-.16l1.5-1.5a.75.75 0 0 0 .16-.86l-.67-1.43c.13-.35.24-.71.32-1.07l1.35-.78v-1.5z"/>
    </svg>
  </button>
</div>

<div class="lang-switcher">
  <button class="lang-btn active" data-lang="th">‡πÑ‡∏ó‡∏¢</button>
  <button class="lang-btn" data-lang="mm">·Äô·Äº·Äî·Ä∫·Äô·Ä¨</button>
  <button class="lang-btn" data-lang="km">·ûÅ·üí·ûò·üÇ·ûö</button>
</div>

<div class="modal-backdrop" id="guardModal">
  <div class="modal">
    <h2>üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î ‡∏£‡∏õ‡∏†.</h2>
    <p style="text-align:center;color:#6b7280;font-size:0.85rem;margin:0 0 10px 0;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</p>
    <input type="password" id="guardPassword" placeholder="********">
    <div class="modal-buttons">
      <button class="btn-small btn-cancel" id="cancelLogin">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn-small btn-login" id="confirmLogin">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </div>
</div>

<div class="guard-panel" id="guardPanel">
  <div class="guard-tabs">
    <button class="tab-btn active" data-tab="scan">‡∏™‡πÅ‡∏Å‡∏ô QR</button>
    <button class="tab-btn" data-tab="report">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
  </div>

  <div class="scan-section active" id="scanTab">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="canvas"></canvas>
    <div style="margin-top:8px;">
      <label style="font-size:0.8rem;color:#4b5563;">
        ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ QR:
        <input type="file" id="qrImageInput" accept="image/*" style="margin-top:6px;padding:8px;font-size:0.8rem;">
      </label>
    </div>
    <div id="scan-result" class="employee-detail" style="display:none;">
      <img id="scan-photo" class="employee-photo" alt="‡∏£‡∏π‡∏õ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">
      <div class="detail-grid">
        <div class="detail-label">‡∏ä‡∏∑‡πà‡∏≠:</div><div id="scan-name"></div>
        <div class="detail-label">‡∏£‡∏´‡∏±‡∏™:</div><div id="scan-code"></div>
        <div class="detail-label">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó:</div><div id="scan-company"></div>
        <div class="detail-label">‡πÅ‡∏ú‡∏ô‡∏Å:</div><div id="scan-dept"></div>
        <div class="detail-label">‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏≠‡∏Å:</div><div id="scan-time"></div>
        <div class="detail-label">‡∏£‡∏õ‡∏†.‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô:</div><div id="scan-guard-time"></div>
      </div>
      <button class="guard-confirm-btn" id="guardConfirmBtn">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
    </div>
  </div>

  <div class="report-section" id="reportTab">
    <div class="report-container">
      <table class="report-table" id="reportTable">
        <thead>
          <tr>
            <th>‡∏£‡∏π‡∏õ</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
            <th>‡∏£‡∏´‡∏±‡∏™</th>
            <th>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
            <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
            <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£</th>
            <th>‡∏£‡∏õ‡∏†.‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</th>
            <th style="min-width:200px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡πÅ‡∏Å‡∏ô (‡πÄ‡∏ß‡∏•‡∏≤)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <button class="export-btn" id="exportExcel">üìä ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel</button>
  </div>
</div>

<div class="container" id="main-container"></div>

<script>
const translations = {
  th: {
    title: "‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà",
    subtitle: "‡∏Å‡∏£‡∏ì‡∏µ 3.2.2 - ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å",
    name: "‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•",
    code: "‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô",
    company: "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó",
    dept: "‡πÅ‡∏ú‡∏ô‡∏Å",
    photo: "‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô",
    generate: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô",
    pdpa_title: "PDPA - ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß",
    pdpa_text: `‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ä‡∏∑‡πà‡∏≠ ‡∏£‡∏´‡∏±‡∏™ ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏Å‡∏≤‡∏£‡∏Å‡∏î "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£" = ‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏ï‡∏≤‡∏° ‡∏û.‡∏£.‡∏ö.‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`,
    consent: "‡∏â‡∏±‡∏ô‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏° PDPA",
    card_subtitle: "‡∏Å‡∏£‡∏ì‡∏µ 3.2.2 - ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å",
    name_label: "‡∏ä‡∏∑‡πà‡∏≠",
    code_label: "‡∏£‡∏´‡∏±‡∏™",
    dept_label: "‡πÅ‡∏ú‡∏ô‡∏Å",
    company_label: "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó",
    qr_title: "QR Code",
    qr_hint: "‡πÅ‡∏™‡∏î‡∏á‡∏ï‡πà‡∏≠‡∏£‡∏õ‡∏†.",
    status_title: "‚úÖ ‡∏ö‡∏±‡∏ï‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
    status_text: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå",
    new_card: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà",
    screenshot: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠"
  },
  mm: {
    title: "·ÄÖ·ÄÄ·Ä∫·Äõ·ÄØ·Ä∂·Äï·Äº·ÄÑ·Ä∫·Äï ·Äë·ÄΩ·ÄÄ·Ä∫·ÄÅ·ÄΩ·ÄÑ·Ä∑·Ä∫",
    subtitle: "·Ä°·ÄÅ·Äº·Ä±·Ä°·Äî·Ä± 3.2.2",
    name: "·Ä°·Äô·Ää·Ä∫",
    code: "·Äî·Ä∂·Äï·Ä´·Äê·Ä∫",
    company: "·ÄÄ·ÄØ·Äô·Äπ·Äï·Äè·ÄÆ",
    dept: "·Äå·Ä¨·Äî",
    photo: "·Äì·Ä¨·Äï·ÄØ·Ä∂",
    generate: "·ÄÄ·Äê·Ä∫·Äñ·Äî·Ä∫·Äê·ÄÆ·Ä∏",
    pdpa_title: "PDPA",
    pdpa_text: `·ÄÄ·ÄØ·Äô·Äπ·Äï·Äè·ÄÆ·Äû·Ää·Ä∫ ·Ä°·ÄÅ·Äª·ÄÄ·Ä∫·Ä°·Äú·ÄÄ·Ä∫·Äô·Äª·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ ·Äú·ÄØ·Ä∂·ÄÅ·Äº·ÄØ·Ä∂·Äõ·Ä±·Ä∏·Ä°·Äê·ÄΩ·ÄÄ·Ä∫·Äû·Ä¨ ·Äû·Ä≠·Äô·Ä∫·Ä∏·Äô·Ää·Ä∫`,
    consent: "PDPA ·Äú·ÄÄ·Ä∫·ÄÅ·Ä∂",
    card_subtitle: "·Ä°·ÄÅ·Äº·Ä±·Ä°·Äî·Ä± 3.2.2",
    name_label: "·Ä°·Äô·Ää·Ä∫",
    code_label: "·Äî·Ä∂·Äï·Ä´·Äê·Ä∫",
    dept_label: "·Äå·Ä¨·Äî",
    company_label: "·ÄÄ·ÄØ·Äô·Äπ·Äï·Äè·ÄÆ",
    qr_title: "QR Code",
    qr_hint: "·Äú·ÄØ·Ä∂·ÄÅ·Äº·ÄØ·Ä∂·Äõ·Ä±·Ä∏·Äë·Ä∂·Äï·Äº·Äï·Ä´",
    status_title: "‚úÖ ·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äõ·Äî·Ä∫·Ä°·ÄÜ·ÄÑ·Ä∫·Äû·ÄÑ·Ä∑·Ä∫",
    status_text: "·Äô·Äª·ÄÄ·Ä∫·Äî·Äæ·Ä¨·Äï·Äº·ÄÑ·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏",
    new_card: "·ÄÄ·Äê·Ä∫·Ä°·Äû·ÄÖ·Ä∫",
    screenshot: "·Äô·Äª·ÄÄ·Ä∫·Äî·Äæ·Ä¨·Äï·Äº·ÄÑ·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏"
  },
  km: {
    title: "·ûü·üí·ûì·ûæ·ûÖ·üÅ·ûâ·ûÄ·üí·ûö·üÖ",
    subtitle: "·ûÄ·ûö·ûé·û∏ 3.2.2",
    name: "·ûà·üí·ûò·üÑ·üá",
    code: "·ûÄ·ûº·ûä",
    company: "·ûÄ·üí·ûö·ûª·ûò·û†·üä·ûª·ûì",
    dept: "·ûì·û∂·ûô·ûÄ·ûä·üí·ûã·û∂·ûì",
    photo: "·ûö·ûº·ûî·ûê·ûè",
    generate: "·ûî·ûÑ·üí·ûÄ·ûæ·ûè",
    pdpa_title: "PDPA",
    pdpa_text: `·ûÄ·üí·ûö·ûª·ûò·û†·üä·ûª·ûì·ûì·ûπ·ûÑ·ûö·ûÄ·üí·ûü·û∂·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûü·ûò·üí·ûö·û∂·ûî·üã·ûü·ûª·ûú·ûè·üí·ûê·û∑·ûó·û∂·ûñ·ûè·üÇ·ûî·üâ·ûª·ûé·üí·ûé·üÑ·üá`,
    consent: "PDPA ·ûô·ûõ·üã·ûñ·üí·ûö·ûò",
    card_subtitle: "·ûÄ·ûö·ûé·û∏ 3.2.2",
    name_label: "·ûà·üí·ûò·üÑ·üá",
    code_label: "·ûÄ·ûº·ûä",
    dept_label: "·ûì·û∂·ûô·ûÄ·ûä·üí·ûã·û∂·ûì",
    company_label: "·ûÄ·üí·ûö·ûª·ûò·û†·üä·ûª·ûì",
    qr_title: "QR Code",
    qr_hint: "·ûî·ûÑ·üí·û†·û∂·ûâ·ûä·ûõ·üã·ûü·ûª·ûú·ûè·üí·ûê·û∑·ûó·û∂·ûñ",
    status_title: "‚úÖ ·ûö·ûΩ·ûÖ·ûö·û∂·ûõ·üã",
    status_text: "·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ·û¢·üÅ·ûÄ·üí·ûö·ûÑ·üã",
    new_card: "·ûî·ûÑ·üí·ûÄ·ûæ·ûè·ûê·üí·ûò·û∏",
    screenshot: "·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ·û¢·üÅ·ûÄ·üí·ûö·ûÑ·üã"
  }
};

const companies = [
  "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏≠‡∏µ.‡∏Ñ‡∏¥‡∏ß. ‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î (EQO)",
  "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÑ‡∏ó‡∏¢‡∏≠‡∏µ‡∏™‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô ‡∏≠‡∏¥‡∏ô‡πÇ‡∏ô‡πÄ‡∏ß‡∏ä‡∏±‡πà‡∏ô ‡∏à‡∏≥‡∏Å‡∏±‡∏î (TEI)",
  "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÑ‡∏ó‡∏¢‡∏≠‡∏µ‡∏™‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô ‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î (TER)",
  "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏≠‡∏µ‡∏™‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô ‡∏õ‡∏≤‡∏•‡πå‡∏° ‡∏≠‡∏≠‡∏¢‡∏•‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î (EPO)",
  "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÑ‡∏ó‡∏¢‡∏≠‡∏µ‡∏™‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô ‡∏ó‡πâ‡∏≠‡∏õ‡∏ã‡∏µ‡∏î‡∏™‡πå ‡∏≠‡∏≠‡∏¢‡∏•‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î (TETSO)",
  "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÑ‡∏ó‡∏¢‡∏≠‡∏µ‡∏™‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô ‡πÑ‡∏ö‡πÇ‡∏≠ ‡∏û‡∏≤‡∏ß‡πÄ‡∏ß‡∏≠‡∏£‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î (‡∏°‡∏´‡∏≤‡∏ä‡∏ô) (TEBP)",
  "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÑ‡∏ó‡∏¢‡∏≠‡∏µ‡∏™‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô ‡πÇ‡∏•‡∏à‡∏¥‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î (TEL)",
  "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÑ‡∏ó‡∏¢‡∏≠‡∏µ‡∏™‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏™‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏• ‡πÅ‡∏•‡∏ô‡∏î‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î (TEIL)"
];

let currentLang = 'th';
let employeeData = JSON.parse(localStorage.getItem('tegEmployeeData')) || [];
let isGuardMode = false;
let video, canvas, ctx;
let currentScannedKey = null;
let isProcessing = false;

document.addEventListener('DOMContentLoaded', function() {
  console.log('üî• TEG 3.2.2 Loaded');
  setupLanguageSwitcher();
  setupGuardMode();
  showForm(document.getElementById('main-container'));
});

function setupLanguageSwitcher() {
  document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      currentLang = this.dataset.lang;
      document.querySelector('.lang-btn.active')?.classList.remove('active');
      this.classList.add('active');
      if (!isGuardMode) {
        showForm(document.getElementById('main-container'));
      }
    });
  });
}

function setupGuardMode() {
  const guardBtn = document.getElementById('guardBtn');
  const modal = document.getElementById('guardModal');
  const cancelBtn = document.getElementById('cancelLogin');
  const loginBtn = document.getElementById('confirmLogin');
  
  guardBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    modal.style.display = 'flex';
  });
  
  cancelBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    modal.style.display = 'none';
    document.getElementById('guardPassword').value = '';
  });
  
  loginBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    const password = document.getElementById('guardPassword').value;
    if (password === 'Teg2025+') {
      modal.style.display = 'none';
      document.getElementById('guardPassword').value = '';
      isGuardMode = true;
      document.getElementById('guardPanel').style.display = 'block';
      document.getElementById('main-container').style.display = 'none';
      initQRScanner();
      loadReport();
    } else {
      alert('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      document.getElementById('guardPassword').value = '';
    }
  });
  
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      document.querySelector('.tab-btn.active')?.classList.remove('active');
      this.classList.add('active');
      document.querySelectorAll('.scan-section, .report-section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(this.dataset.tab + 'Tab')?.classList.add('active');
      if (this.dataset.tab === 'scan') initQRScanner();
      if (this.dataset.tab === 'report') loadReport();
    });
  });
  
  document.getElementById('exportExcel')?.addEventListener('click', exportToExcel);
  document.getElementById('qrImageInput')?.addEventListener('change', handleQrImageUpload);
  
  document.addEventListener('click', function(e) {
    if (e.target.id === 'guardConfirmBtn') {
      guardConfirmAction();
    }
  });
}

function showForm(container) {
  const t = translations[currentLang];
  container.innerHTML = `
    <h1>${t.title}</h1>
    <p style="text-align:center;color:#6b7280;font-size:0.85rem;margin-bottom:16px;">${t.subtitle}</p>
    <form id="employeeForm" class="form-section">
      <div class="form-group">
        <label>${t.name} <span style="color:#ef4444;">*</span></label>
        <input type="text" id="name1" required placeholder="${t.name}">
      </div>
      <div class="form-group">
        <label>${t.code} <span style="color:#ef4444;">*</span></label>
        <input type="text" id="code1" required placeholder="${t.code}">
      </div>
      <div class="form-group">
        <label>${t.company} <span style="color:#ef4444;">*</span></label>
        <select id="company1" required>
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó --</option>
          ${companies.map(c => `<option value="${c}">${c}</option>`).join('')}
        </select>
      </div>
      <div class="form-group">
        <label>${t.dept} <span style="color:#ef4444;">*</span></label>
        <input type="text" id="dept1" required placeholder="${t.dept}">
      </div>
      <div class="pdpa-notice">
        <h4>${t.pdpa_title}</h4>
        <div>${t.pdpa_text}</div>
        <label class="pdpa-checkbox">
          <input type="checkbox" id="pdpa-consent">
          <span>${t.consent} <span style="color:#ef4444;">*</span></span>
        </label>
      </div>
      <div class="form-group">
        <label>${t.photo} <span style="color:#ef4444;">*</span></label>
        <input type="file" id="photo1" accept="image/*" required>
        <img id="preview1" style="display:none;">
      </div>
      <button type="button" class="main-button generate-button" id="generateBtn" disabled>
        üì± ${t.generate}
      </button>
    </form>
  `;
  
  setupFormEvents();
}

function setupFormEvents() {
  const photoInput = document.getElementById('photo1');
  const preview = document.getElementById('preview1');
  const generateBtn = document.getElementById('generateBtn');
  
  function checkFormReady() {
    try {
      const name = document.getElementById('name1')?.value.trim();
      const code = document.getElementById('code1')?.value.trim();
      const company = document.getElementById('company1')?.value;
      const dept = document.getElementById('dept1')?.value.trim();
      const pdpa = document.getElementById('pdpa-consent')?.checked;
      const photo = photoInput?.files && photoInput.files.length > 0;
      
      const isReady = name && code && company && dept && pdpa && photo;
      if (generateBtn) {
        generateBtn.disabled = !isReady;
        generateBtn.textContent = isReady ? '‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' : 'üì± ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
      }
    } catch(e) {
      console.error('Form check:', e);
    }
  }
  
  if (photoInput) {
    photoInput.addEventListener('change', function(e) {
      console.log('üì∏ Photo selected');
      const file = e.target.files[0];
      if (file) {
        if (file.size > 3 * 1024 * 1024) {
          alert('‚ö†Ô∏è ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3MB');
          photoInput.value = '';
          checkFormReady();
          return;
        }
        
        const reader = new FileReader();
        const timeoutId = setTimeout(() => {
          reader.abort();
          alert('‚ùå ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
          photoInput.value = '';
          preview.style.display = 'none';
          checkFormReady();
        }, 10000);
        
        reader.onload = function(e2) {
          clearTimeout(timeoutId);
          preview.src = e2.target.result;
          preview.style.display = 'block';
          console.log('‚úÖ Photo OK');
          checkFormReady();
        };
        
        reader.onerror = function() {
          clearTimeout(timeoutId);
          alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ');
          photoInput.value = '';
          preview.style.display = 'none';
          checkFormReady();
        };
        
        reader.readAsDataURL(file);
      } else {
        preview.style.display = 'none';
        checkFormReady();
      }
    });
  }
  
  ['name1', 'code1', 'dept1'].forEach(id => {
    document.getElementById(id)?.addEventListener('input', checkFormReady);
  });
  
  document.getElementById('company1')?.addEventListener('change', checkFormReady);
  document.getElementById('pdpa-consent')?.addEventListener('change', checkFormReady);
  
  if (generateBtn) {
    generateBtn.addEventListener('click', function(e) {
      e.preventDefault();
      if (!this.disabled && !isProcessing) {
        createProfessionalCard();
      }
    });
  }
  
  checkFormReady();
}

function createProfessionalCard() {
  if (isProcessing) {
    console.log('‚ö†Ô∏è Processing...');
    return;
  }
  
  isProcessing = true;
  
  try {
    const name = document.getElementById('name1')?.value.trim();
    const code = document.getElementById('code1')?.value.trim();
    const company = document.getElementById('company1')?.value;
    const dept = document.getElementById('dept1')?.value.trim();
    const file = document.getElementById('photo1')?.files[0];
    const t = translations[currentLang];
    
    if (!file) {
      alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ');
      isProcessing = false;
      return;
    }
    
    const generateBtn = document.getElementById('generateBtn');
    if (generateBtn) {
      generateBtn.disabled = true;
      generateBtn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...';
    }
    
    const reader = new FileReader();
    const timeoutId = setTimeout(() => {
      reader.abort();
      alert('‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
      if (generateBtn) {
        generateBtn.disabled = false;
        generateBtn.textContent = 'üì± ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
      }
      isProcessing = false;
    }, 15000);
    
    reader.onload = function(e) {
      clearTimeout(timeoutId);
      const photoData = e.target.result;
      const key = 'EMP_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      const employee = {
        key, name, code, company, dept, photoData,
        timestamp: new Date().toISOString(),
        guardConfirmTime: null,
        scanLogs: []
      };
      
      employeeData.unshift(employee);
      try {
        localStorage.setItem('tegEmployeeData', JSON.stringify(employeeData));
      } catch(err) {
        console.error('Storage full:', err);
        alert('‚ö†Ô∏è ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤');
      }
      
      console.log('‚úÖ Card created:', key);
      isProcessing = false;
      showEmployeeCard(name, code, company, dept, photoData, key, t);
    };
    
    reader.onerror = function() {
      clearTimeout(timeoutId);
      alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ');
      if (generateBtn) {
        generateBtn.disabled = false;
        generateBtn.textContent = 'üì± ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
      }
      isProcessing = false;
    };
    
    reader.readAsDataURL(file);
  } catch(e) {
    console.error('Error:', e);
    alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
    isProcessing = false;
  }
}

function showEmployeeCard(name, code, company, dept, photoData, key, t) {
  const container = document.getElementById('main-container');
  container.innerHTML = `
    <div class="card-section" id="card-capture">
      <div class="employee-card">
        <div class="card-header">
          <h3 class="card-company">${company}</h3>
          <p class="card-subtitle">${t.card_subtitle}</p>
        </div>
        <div class="card-body">
          <img src="${photoData}" class="card-photo" alt="photo">
          <div class="card-details">
            <div class="detail-row">
              <span class="detail-label">${t.name_label}</span>
              <span class="detail-value">${name}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">${t.code_label}</span>
              <span class="detail-value">${code}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">${t.dept_label}</span>
              <span class="detail-value">${dept}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">${t.company_label}</span>
              <span class="detail-value">${company}</span>
            </div>
          </div>
        </div>
      </div>
      <div class="qr-container">
        <div class="qr-title">${t.qr_title}</div>
        <canvas id="qr-canvas"></canvas>
        <div class="qr-hint">${t.qr_hint}</div>
      </div>
      <div class="status-info">
        <h3>${t.status_title}</h3>
        <p>${t.status_text}</p>
      </div>
    </div>
    <button class="main-button screenshot-btn" id="screenshotBtn">
      üì∏ ${t.screenshot}
    </button>
    <button class="main-button" onclick="location.reload()" style="background:#6b7280;color:white;margin-top:10px;">
      üîÑ ${t.new_card}
    </button>
  `;
  
  setTimeout(() => {
    try {
      const qrCanvas = document.getElementById('qr-canvas');
      if (qrCanvas) {
        const qrUrl = `${window.location.origin}${window.location.pathname}?key=${key}`;
        new QRious({ element: qrCanvas, value: qrUrl, size: 200, level: 'H' });
        console.log('‚úÖ QR OK');
      }
    } catch(e) {
      console.error('QR Error:', e);
    }
  }, 200);
  
  document.getElementById('screenshotBtn')?.addEventListener('click', async function() {
    try {
      this.disabled = true;
      this.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      
      const captureElement = document.getElementById('card-capture');
      const canvas = await html2canvas(captureElement, {
        backgroundColor: null,
        scale: 2,
        logging: false
      });
      
      canvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `TEG_Card_${code}_${Date.now()}.png`;
        a.click();
        URL.revokeObjectURL(url);
        
        this.disabled = false;
        this.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        setTimeout(() => {
          this.textContent = `üì∏ ${t.screenshot}`;
        }, 2000);
      });
    } catch(e) {
      console.error('Screenshot error:', e);
      alert('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
      this.disabled = false;
      this.textContent = `üì∏ ${t.screenshot}`;
    }
  });
}

function initQRScanner() {
  if (video?.srcObject) return;
  
  video = document.getElementById('video');
  canvas = document.getElementById('canvas');
  ctx = canvas?.getContext('2d');
  
  navigator.mediaDevices.getUserMedia({ 
    video: { facingMode: 'environment', width: 1280, height: 720 } 
  })
  .then(stream => {
    video.srcObject = stream;
    video.play();
    requestAnimationFrame(tick);
  })
  .catch(err => {
    console.error('Camera:', err);
    document.getElementById('scanTab').innerHTML += 
      '<p style="color:red;text-align:center;padding:16px;">üì± ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</p>';
  });
}

function tick() {
  if (!isGuardMode || !video || video.readyState !== video.HAVE_ENOUGH_DATA) {
    requestAnimationFrame(tick);
    return;
  }
  
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const code = jsQR(imageData.data, imageData.width, imageData.height);
  
  if (code?.data.includes('?key=')) {
    const url = new URL(code.data);
    const key = url.searchParams.get('key');
    if (key) {
      console.log('üîç QR:', key);
      showEmployeeByKey(key);
      return;
    }
  }
  
  requestAnimationFrame(tick);
}

function handleQrImageUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(ev) {
    const img = new Image();
    img.onload = function() {
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      
      if (code?.data.includes('?key=')) {
        const url = new URL(code.data);
        const key = url.searchParams.get('key');
        if (key) {
          showEmployeeByKey(key);
        } else {
          alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö key');
        }
      } else {
        alert('‚ùå ‡∏≠‡πà‡∏≤‡∏ô QR ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
      }
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
}

function showEmployeeByKey(key) {
  const emp = employeeData.find(e => e.key === key);
  if (!emp) { 
    alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
    return; 
  }
  
  const scanLog = {
    scanTime: new Date().toISOString(),
    scanDate: new Date().toLocaleDateString('th-TH'),
    scanTimeLocal: new Date().toLocaleString('th-TH')
  };
  if (!emp.scanLogs) emp.scanLogs = [];
  emp.scanLogs.unshift(scanLog);
  
  currentScannedKey = key;
  
  document.getElementById('scan-photo').src = emp.photoData;
  document.getElementById('scan-name').textContent = emp.name;
  document.getElementById('scan-code').textContent = emp.code;
  document.getElementById('scan-company').textContent = emp.company;
  document.getElementById('scan-dept').textContent = emp.dept;
  document.getElementById('scan-time').textContent = new Date(emp.timestamp).toLocaleString('th-TH');
  document.getElementById('scan-guard-time').textContent = emp.guardConfirmTime
    ? new Date(emp.guardConfirmTime).toLocaleString('th-TH') : '-';
    
  document.getElementById('scan-result').style.display = 'block';
  localStorage.setItem('tegEmployeeData', JSON.stringify(employeeData));
}

function guardConfirmAction() {
  if (!currentScannedKey) { 
    alert('‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
    return; 
  }
  
  const index = employeeData.findIndex(e => e.key === currentScannedKey);
  if (index === -1) { 
    alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
    return; 
  }
  
  const now = new Date().toISOString();
  const confirmLog = {
    scanTime: now,
    scanDate: new Date().toLocaleDateString('th-TH'),
    scanTimeLocal: new Date().toLocaleString('th-TH'),
    guardConfirmed: true
  };
  
  employeeData[index].scanLogs.unshift(confirmLog);
  employeeData[index].guardConfirmTime = now;
  
  localStorage.setItem('tegEmployeeData', JSON.stringify(employeeData));
  document.getElementById('scan-guard-time').textContent = new Date(now).toLocaleString('th-TH');
  
  alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  loadReport();
  document.getElementById('scan-result').style.display = 'none';
  currentScannedKey = null;
}

// üî• ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
function loadReport() {
  const tbody = document.querySelector('#reportTable tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  employeeData.slice(0, 100).forEach(emp => {
    const totalScans = emp.scanLogs?.length || 0;
    const tr = document.createElement('tr');
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡πÅ‡∏Å‡∏ô
    let scanHistoryHTML = '<div class="scan-history">';
    if (totalScans > 0) {
      emp.scanLogs.slice(0, 20).forEach(log => {
        const isConfirmed = log.guardConfirmed || false;
        scanHistoryHTML += `
          <div class="scan-item ${isConfirmed ? 'confirmed' : ''}">
            <span class="scan-time">${log.scanTimeLocal}</span>
            ${isConfirmed ? '<span class="scan-badge">‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</span>' : ''}
          </div>
        `;
      });
      if (totalScans > 20) {
        scanHistoryHTML += `<div style="text-align:center;padding:4px;color:#6b7280;font-size:0.65rem;">...‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${totalScans - 20} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>`;
      }
    } else {
      scanHistoryHTML += '<div style="text-align:center;color:#9ca3af;padding:8px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô</div>';
    }
    scanHistoryHTML += '</div>';
    
    tr.innerHTML = `
      <td class="photo-cell"><img src="${emp.photoData}" alt=""></td>
      <td>${emp.name}</td>
      <td>${emp.code}</td>
      <td>${emp.company.substring(0,18)}...</td>
      <td>${emp.dept.substring(0,12)}...</td>
      <td>${new Date(emp.timestamp).toLocaleString('th-TH')}</td>
      <td>${emp.guardConfirmTime ? new Date(emp.guardConfirmTime).toLocaleString('th-TH') : '-'}</td>
      <td>
        <span class="total-scans">${totalScans} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
        ${scanHistoryHTML}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function exportToExcel() {
  let csv = '\uFEFF‡∏ä‡∏∑‡πà‡∏≠,‡∏£‡∏´‡∏±‡∏™,‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó,‡πÅ‡∏ú‡∏ô‡∏Å,‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£,‡∏£‡∏õ‡∏†.‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î,‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡πÅ‡∏Å‡∏ô (20 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)\n';
  employeeData.forEach(emp => {
    const totalScans = emp.scanLogs?.length || 0;
    const scanDetails = emp.scanLogs?.slice(0,20).map((log, idx) => 
      `${idx+1}. ${log.scanTimeLocal}${log.guardConfirmed ? ' ‚úì‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' : ''}`
    ).join(' | ') || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô';
    
    csv += `"${emp.name}","${emp.code}","${emp.company}","${emp.dept}","${new Date(emp.timestamp).toLocaleString('th-TH')}","${emp.guardConfirmTime ? new Date(emp.guardConfirmTime).toLocaleString('th-TH') : '-'}","${totalScans}","${scanDetails}"\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `TEG_Report_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
}

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(() => {});
}
</script>
</body>
</html>
